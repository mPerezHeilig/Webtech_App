<!-- bearbeitet von Marcia Perez Heilig -->

<!-- Page showing form for editing an existing trip -->

<html>
    <head>
        <title>Travel Planner - Edit Trip</title>
        <link rel="stylesheet" type="text/css" href="./css/default.css">
    </head>
    <body>
        <h1>Travel Planner</h1>

        <div class="displayCard">
            <h2>Edit Trip</h2>

            <form class="tripForm">

                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" placeholder="Name your Trip">
                </div>

                <div class="form-group">
                    <label for="departure_date">Departure Date:</label>
                    <input type="date" id="departure_date" name="departure_date">
                </div>

                <div class="form-group">
                    <label for="return_date">Return Date:</label>
                    <input type="date" id="return_date" name="return_date">
                </div>

                <div class="form-group">
                    <label for="country">Country:</label>
                    <select id="country" name="country">
                        <option value="" disabled selected>Choose Country</option>
                        <option value="Spain">Spain</option>
                        <option value="Germany">Germany</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tourguide">Tourguide:</label>
                    <select id="tourguide" name="tourguide">
                        <option value="" disabled selected>Choose Tourguide</option>
                        <option value="Miguel">Miguel</option>
                        <option value="Hans">Hans</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <button type="button" id="submitButton" class="alarmButton">Update Trip</button>
                    <a href="/showtrips.html">Show Trip Collection</a>
                </div>
            </form>
        </div>

        <a href="/index.html">Back</a>

        
        <!-- JavaScript for querying-->
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {

            // Select the country selection inside the form
            const country_select = document.getElementById('country');

            //Function to fetch and display country options
            const loadCountryOptions = () => {
                axios.get('api/countries')
                    .then(response => {
                        const countries = response.data;
                    
                        // Clear existing options except the default one
                        country_select.innerHTML = '<option value="" disabled selected>Choose Country</option>';
                    
                        // Loop through all countries and create an select option for each one
                        countries.forEach(country => {
                            const country_option = document.createElement('option');
                            country_option.value = country;
                            country_option.textContent = country;
                            country_select.appendChild(country_option);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching countries:', error);
                        alert('Failed to load country options.');
                    });
            };

            // Load country options
            loadCountryOptions();

            // Select the tourguide selection inside the form
            const tourguide_select = document.getElementById('tourguide');

            //Function to fetch and display tourguide options
            const loadTourguideOptions = () => {
                axios.get('api/tourguides')
                    .then(response => {
                        const tourguides = response.data;
                    
                        // Clear existing options except the default one
                        tourguide_select.innerHTML = '<option value="" disabled selected>Choose Tourguide</option>';
                    
                        // Loop through all countries and create an select option for each one
                        tourguides.forEach(tourguide => {
                            const tourguide_option = document.createElement('option');
                            tourguide_option.value = tourguide;
                            tourguide_option.textContent = tourguide;
                            tourguide_select.appendChild(tourguide_option);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching tourguides:', error);
                        alert('Failed to load tourguide options.');
                    });
            };

            // Load tourguide options
            loadTourguideOptions();

            
            const form = document.querySelector('.tripForm');
            const submitButton = document.getElementById('submitButton');

            // Function to prefill the form inputs with trip data for specific trip by ID
            const loadTripData = (tripId) => {
                axios.get(`/api/trips/${tripId}`)
                    .then(response => {
                        const trip = response.data;
                        document.getElementById('name').value = trip._name;
                        document.getElementById('departure_date').value = trip._departure_date;
                        document.getElementById('return_date').value = trip._return_date;
                        document.getElementById('country').value = trip._dest_country;
                        document.getElementById('tourguide').value = trip._tourguide;
                    })
                    .catch(error => {
                        console.error('Error fetching trip data:', error);
                        alert('Error loading trip details.');
                    });
            };
            
            // Function to update trip details
            const updateTrip = (tripId) => {
                const updatedTrip = {
                    name: document.getElementById('name').value,
                    departure_date: document.getElementById('departure_date').value,
                    return_date: document.getElementById('return_date').value,
                    dest_country: document.getElementById('country').value,
                    tourguide: document.getElementById('tourguide').value,
                };
            
                axios.put(`/api/trips/${tripId}`, updatedTrip)
                    .then(() => {
                        alert('Trip updated successfully!');
                        window.location.href = '/showtrips.html'; // Redirect
                    })
                    .catch(error => {
                        console.error('Error updating trip:', error);
                        alert('Error updating trip.');
                    });
            };
        
            axios.get('/api/selectedTrip')
                .then(response => {
                    const tripId = response.data.tripId;
                    if (tripId) {
                        // Load data to prefill form inputs
                        loadTripData(tripId);
                    
                        submitButton.addEventListener('click', (event) => {
                            event.preventDefault();
                            // Update trip details
                            updateTrip(tripId);
                        });
                    } else {
                        alert('No trip ID found. Redirecting to trips page.');
                        window.location.href = '/showtrips.html';
                    }
                })
                .catch(error => {
                    console.error('Error retrieving trip ID:', error);
                    alert('Error initializing edit page.');
                });
            });
        </script>

    </body>
</html>